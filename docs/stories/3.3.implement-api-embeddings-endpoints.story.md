# Story 3.3: Implement /api/embeddings Endpoints with Translation Engine

**⚠️ CRITICAL: All Python activities including running unit tests, integration tests, and any Python commands MUST be executed inside the virtual environment (venv). Always activate the virtual environment first with `source venv/bin/activate` before running any Python-related commands.**

## Status
Complete

## Story
**As an** Ollama SDK user,
**I want** to generate embeddings using client.embeddings() method with seamless translation between Ollama and OpenAI formats,
**so that** I can create vector representations of text for semantic search and similarity operations.

## Acceptance Criteria
1. POST /api/embeddings endpoint is implemented and working
2. POST /api/embed endpoint aliases to same functionality  
3. Endpoint accepts model and prompt parameters in Ollama format
4. Request is translated to OpenAI embeddings format correctly
5. Response returns embedding array in Ollama format
6. Both endpoints return identical responses
7. Ollama prompt is converted to OpenAI input format
8. Model name is correctly mapped
9. OpenAI embedding response is extracted to array format
10. Response contains only the embedding array as expected by Ollama
11. High-dimensional embeddings are handled without truncation
12. Unit tests verify dimension preservation

## Tasks / Subtasks
- [x] Review API compliance requirements (AC: 3, 4, 7)
  - [x] Read architecture/api-compliance-checklist.md
  - [x] Check architecture/ollama-api-implementation.md for /api/embed details
  - [x] Review architecture/ollama-api-analysis-chat-embeddings.md for embeddings specifics
  - [x] Load Ollama OpenAPI specification for embeddings endpoint
- [x] Create Ollama embeddings request/response models (AC: 3)
  - [x] Define OllamaEmbeddingsRequest in src/models/ollama.py
  - [x] Define OllamaEmbeddingsResponse in src/models/ollama.py  
  - [x] Add validation for required fields (model, prompt)
  - [x] Ensure models match OpenAPI specification exactly
- [x] Implement /api/embeddings and /api/embed routers (AC: 1, 2, 6)
  - [x] Create src/routers/embeddings.py
  - [x] Add POST /api/embeddings endpoint
  - [x] Add POST /api/embed endpoint that routes to same handler
  - [x] Add request validation using Pydantic models
  - [x] Implement proper async handler
- [x] Implement embeddings translation functions (AC: 4, 5, 7-11)
  - [x] Create translate_embeddings_request() in src/services/translator.py
  - [x] Convert Ollama prompt to OpenAI input format (prompt → input)
  - [x] Map model names appropriately
  - [x] Create translate_embeddings_response() for response conversion
  - [x] Extract embedding array from OpenAI response format
  - [x] Handle high-dimensional embeddings without truncation
  - [x] Ensure response contains only embedding array field
- [x] Unit tests for embeddings endpoints (AC: 1-12)
  - [x] Test request validation with various inputs
  - [x] Test model name validation
  - [x] Test both endpoint paths return same response
  - [x] Test embedding dimension preservation
  - [x] Test high-dimensional vectors (1536, 3072, etc.)
  - [x] Test error handling for invalid requests
  - [x] Test empty/long prompts
  - [x] Verify all unit tests are passing
- [x] Integration tests with Ollama SDK (AC: 1-12)
  - [x] Create tests/integration/test_ollama_sdk_embeddings.py
  - [x] Test client.embeddings() against running server
  - [x] Verify embedding vector dimensions match model
  - [x] Test with different text lengths
  - [x] Test dimension preservation for large embeddings
  - [x] Test error scenarios
  - [x] Verify both endpoints work identically
- [x] API compliance validation (AC: 1-12)
  - [x] Test with Ollama CLI
  - [x] Test with Ollama SDK
  - [x] Validate response format matches spec
  - [x] Verify dimension preservation

## Dev Notes

### Previous Story Insights
From Story 3.1 (Chat Endpoint):
- Use existing error handling framework from src/ollama_openai_proxy/utils/errors.py
- Follow async patterns established in chat endpoint
- Reuse translation service patterns for consistency

### Data Models and Translation Mapping
[Source: architecture/ollama-api-implementation.md]
**OllamaEmbeddingsRequest**:
- model: str - Model identifier
- prompt: str - Text to embed

**Translation Mapping (Ollama → OpenAI)**:
- prompt → input (direct string mapping)
- model → model (preserve as-is)

**Response Format**:
```json
{
  "embedding": [0.1, 0.2, 0.3, ...]
}
```

### API Specifications
[Source: architecture/ollama-api-analysis-chat-embeddings.md]
- Single text input only (not array) in Ollama format
- Output dimensions vary by model (384, 768, 1024, 1536, etc.)
- Both /api/embeddings and /api/embed must work identically
- Response contains single "embedding" field with float array

### Component Specifications
[Source: architecture/source-tree.md]
- Router location: `src/routers/embeddings.py`
- Model definitions: `src/models/ollama.py` (add embeddings models)
- Translation logic: `src/services/translator.py` (add embeddings methods)
- Integration with: `src/services/openai_client.py`
- Error handling: `src/utils/errors.py`

### Testing Requirements
[Source: architecture/coding-standards.md]
- Unit tests must cover all validation scenarios
- Integration tests MUST test against running server instance
- Test with actual Ollama SDK, not mocked
- Verify exact response format matches Ollama spec

### Technical Constraints
[Source: architecture/tech-stack.md]
- Python 3.12 with FastAPI 0.109.0
- Use Pydantic 2.5.3 for data validation
- All route handlers must be async
- Reuse existing OpenAI SDK wrapper service

**Note:** This story merges the original Epic 3 stories 3.3 (Embeddings Endpoints) and 3.4 (Embeddings Translation Engine) as they are tightly coupled and should be implemented together. The translation logic is an integral part of the embeddings endpoint implementation.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-23 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-23 | 1.1 | Merged Story 3.4 (Embeddings Translation Engine) | Bob (Scrum Master) |
| 2025-01-23 | 1.2 | Story approved for development | Bob (Scrum Master) |
| 2025-01-23 | 2.0 | Story implementation complete | James (Developer) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude 3.5 Sonnet (claude-3-5-sonnet-20241022)

### Debug Log References
- Reviewed API compliance requirements and documentation
- Ollama embeddings endpoint expects "model" and "prompt" fields in request (not "input" as shown in Postman)
- Response format is {"embedding": [array]} not {"embeddings": [[array]]}
- Both /api/embeddings and /api/embed endpoints should work identically

### Completion Notes List
- Implemented both /api/embeddings and /api/embed endpoints that handle requests identically
- Added OllamaEmbeddingsRequest and OllamaEmbeddingsResponse models to match Ollama API specification
- Created translation functions to convert between Ollama format (prompt → input, embedding array response) and OpenAI format
- Implemented comprehensive error handling for all OpenAI API errors
- Added full unit test coverage for endpoints and translation functions
- Created integration tests for Ollama SDK compatibility
- Verified high-dimensional embeddings are preserved without truncation
- Both endpoints return identical responses as required
- All tests passing successfully
- Fixed error handling in OpenAIService to properly propagate NotFoundError (404) for invalid models

### File List
- src/ollama_openai_proxy/models/ollama.py (modified - added OllamaEmbeddingsRequest and OllamaEmbeddingsResponse)
- src/ollama_openai_proxy/routes/embeddings.py (created - new embeddings endpoints)
- src/ollama_openai_proxy/routes/__init__.py (created - routers package init)
- src/ollama_openai_proxy/services/enhanced_translation_service.py (modified - added embeddings translation methods)
- src/ollama_openai_proxy/main.py (modified - added embeddings router)
- tests/unit/test_embeddings_endpoint.py (created - unit tests for embeddings endpoints)
- tests/unit/test_embeddings_translation.py (created - unit tests for embeddings translation)
- tests/integration/test_ollama_sdk_embeddings.py (created - integration tests for Ollama SDK)
- src/ollama_openai_proxy/services/openai_service.py (modified - improved error handling to preserve specific OpenAI errors)

## QA Results
*Results from QA Agent review will be populated here*