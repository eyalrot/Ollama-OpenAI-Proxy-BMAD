# Story 3.6: Docker Production Build

## Status
Approved

## Story
**As a** DevOps engineer,
**I want** production-ready Docker images with multi-stage optimization and CI integration,
**so that** I can deploy the service easily across environments with consistent builds.

## Acceptance Criteria
1. Multi-stage Dockerfile optimizes for development, CI, and production targets
2. Final production image is based on python:3.12-slim with minimal size
3. Health check endpoint is properly configured in Docker
4. Image runs as non-root user for security
5. CI pipeline builds and publishes images to GitHub Container Registry (GHCR)
6. Docker Compose files provided for local development and production deployment
7. Build process and deployment instructions documented in README
8. Production image includes proper logging and monitoring hooks

## Tasks / Subtasks
- [x] Create multi-stage Dockerfile (AC: 1, 2)
  - [x] Stage 1: Base - Common dependencies and security setup
  - [x] Stage 2: Development - Hot-reload and dev tools (for future dev containers)
  - [x] Stage 3: CI - Test dependencies and coverage tools
  - [x] Stage 4: Production - Minimal runtime with optimized layers
  - [x] Optimize layer caching for faster builds
- [x] Implement production security hardening (AC: 4)
  - [x] Create dedicated non-root user with minimal permissions
  - [x] Set proper file ownership and permissions
  - [x] Remove unnecessary packages and files from final image
- [x] Configure health check system (AC: 3)
  - [x] Implement comprehensive health endpoint validation
  - [x] Add readiness and liveness check endpoints
  - [x] Configure Docker HEALTHCHECK instruction
- [x] Update CI pipeline for Docker-based builds (AC: 5)
  - [x] Modify GitHub Actions to build multi-stage images
  - [x] Configure GHCR authentication and publishing
  - [x] Implement image tagging strategy (latest, SHA, version)
  - [x] Add Docker-based test execution in CI
- [x] Create production Docker Compose configuration (AC: 6)
  - [x] Production-optimized docker-compose.prod.yml
  - [x] Environment variable configuration management
  - [x] Volume and network configuration for production
  - [x] Integration with external monitoring and logging
- [x] Add production monitoring and logging (AC: 8)
  - [x] Configure structured JSON logging for containers
  - [x] Add application metrics endpoints
  - [x] Implement graceful shutdown handling
- [x] Update documentation (AC: 7)
  - [x] Docker build and deployment instructions in README
  - [x] Environment configuration guide
  - [x] Production deployment examples
  - [x] Troubleshooting and monitoring guidance

## Dev Notes

### Previous Story Insights
From Epic 1-3 completion, we have a working application with comprehensive test coverage. Current Docker setup is basic and needs production optimization for real deployment scenarios.

### Current State Analysis
[Source: docker/Dockerfile and docker/docker-compose.yml]
- Basic single-stage Dockerfile with python:3.12-slim base
- Non-root user already implemented (appuser)
- Basic health check using Python urllib
- Development docker-compose with hot-reload volumes
- No CI integration with Docker builds

### Multi-Stage Architecture Design
[Source: architecture/tech-stack.md]

**Stage Breakdown:**
```dockerfile
# Stage 1: base - Common foundation
FROM python:3.12-slim as base
# Security updates, user creation, common setup

# Stage 2: dev - Development environment  
FROM base as dev
# Development dependencies, debugging tools
# Hot-reload configuration for future dev containers

# Stage 3: ci - CI/Testing environment
FROM base as ci
# Testing dependencies (pytest, coverage tools)
# Optimized for automated testing

# Stage 4: prod - Production runtime
FROM base as prod  
# Only runtime dependencies
# Minimal attack surface, optimized size
```

### Security Requirements
[Source: architecture/coding-standards.md]
- Run as non-root user (already implemented as 'appuser')
- Minimal package installation in production stage
- No development tools in production image
- Proper file permissions and ownership
- Regular security updates in base image

### CI Integration Strategy
[Source: architecture/tech-stack.md - GitHub Actions]
**Updated CI Pipeline:**
- Build multi-stage images in GitHub Actions
- Run tests in CI Docker container for environment parity
- Publish to GitHub Container Registry (ghcr.io)
- Tag images with commit SHA and version tags
- Cache Docker layers for build performance

### Production Deployment Architecture
**Target Environment:** Simple Linux hosts with docker-compose
- Production docker-compose.prod.yml for deployment
- Environment-based configuration management
- External volume mounts for logs and data
- Network configuration for reverse proxy integration
- Health checks for orchestration and monitoring

### Logging and Monitoring Integration
[Source: current main.py JSON logging setup]
- Structured JSON logging already implemented
- Add application metrics endpoint (/metrics)
- Implement graceful shutdown handling (SIGTERM)
- Container-friendly log output (stdout/stderr)

### Image Registry Strategy
**GitHub Container Registry (GHCR):**
- Public registry for open source project
- Integrated with GitHub Actions authentication
- Automatic vulnerability scanning
- Multi-architecture support (future)

### Build Optimization Techniques
- Multi-stage builds to minimize final image size
- Layer caching optimization for faster CI builds
- .dockerignore to exclude unnecessary files
- Dependency installation optimization
- Production vs development dependency separation

### File Locations
[Source: architecture/source-tree.md]
- Main Dockerfile: `docker/Dockerfile` (replace current)
- Production compose: `docker/docker-compose.prod.yml` (new)
- CI workflow: `.github/workflows/docker-build.yml` (new)
- Documentation: `README.md` (update Docker sections)

### Testing Requirements
[Source: architecture/test-strategy-and-standards.md]
- CI must run tests inside Docker containers
- Integration tests against built Docker images
- Health check endpoint validation
- Production image vulnerability scanning
- Performance testing with containerized application

### Technical Constraints
[Source: architecture/tech-stack.md]
- Python 3.12 base image required
- FastAPI 0.109.0 with uvicorn server
- Must maintain <100ms response time overhead
- Support for environment-based configuration
- Compatible with existing application architecture

### Environment Configuration
- Development: Hot-reload volumes for code changes
- CI: Isolated test environment with coverage reporting  
- Production: Optimized runtime with monitoring hooks
- All environments use same base configuration patterns

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-24 | 1.0 | Initial story creation for Docker production optimization | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude 3 Opus (claude-opus-4-20250514)

### Debug Log References
N/A - Implementation completed successfully without debug logs

### Completion Notes List
1. Created comprehensive multi-stage Dockerfile with 4 optimized stages (base, dev, ci, prod)
2. Implemented security hardening with non-root user (appuser:1000) across all stages
3. Enhanced health check system with three endpoints: /health, /ready, /live
4. Created new CI/CD workflow (docker-build.yml) with GHCR integration
5. Built separate Docker Compose files for development and production environments
6. Added metrics endpoint (/metrics) for monitoring with request tracking middleware
7. Implemented graceful shutdown handling for SIGTERM/SIGINT signals
8. Enhanced logging with container-aware JSON formatting
9. Created comprehensive Docker deployment documentation
10. Added .dockerignore for optimized build context

### File List
**Created:**
- `.github/workflows/docker-build.yml` - CI/CD workflow for Docker builds and GHCR publishing
- `docker/docker-compose.prod.yml` - Production Docker Compose configuration
- `docker/docker-compose.dev.yml` - Development Docker Compose configuration
- `.dockerignore` - Docker build context optimization
- `docs/docker-deployment-guide.md` - Comprehensive Docker deployment documentation

**Modified:**
- `docker/Dockerfile` - Complete rewrite with multi-stage build architecture
- `src/ollama_openai_proxy/main.py` - Added health endpoints, metrics, logging enhancements
- `.env.example` - Added Docker-specific configuration variables
- `README.md` - Added Docker deployment sections and instructions

## QA Results
*Results from QA Agent review will be populated here*