# Story 2.1: Implement /api/generate Endpoint

## Status
Complete

## Story
**As an** Ollama SDK user,
**I want** to generate text using client.generate() method,
**so that** I can create AI-generated content through the proxy.

## Acceptance Criteria
1. POST /api/generate endpoint is implemented in FastAPI
2. Endpoint accepts Ollama generate request format with model, prompt, and options
3. Request is validated using Pydantic models
4. Endpoint supports both streaming and non-streaming modes based on request
5. Non-streaming responses return complete JSON response
6. Streaming responses use Server-Sent Events format

## Tasks / Subtasks
- [x] Review API compliance requirements (AC: 2, 3)
  - [x] Read architecture/api-compliance-checklist.md
  - [x] Check architecture/ollama-api-analysis.md for /api/generate quirks
  - [x] Review architecture/epic-1-fix-guide.md for lessons learned
  - [x] Load Ollama OpenAPI specification for reference
- [x] Implement contract tests FIRST (TDD approach) (AC: 1-6)
  - [x] Create tests/contract/test_generate_contract.py
  - [x] Test request format matches Ollama OpenAPI spec
  - [x] Test response format matches Ollama OpenAPI spec
  - [x] Test streaming format compliance (newline-delimited JSON)
  - [x] Use validation tool: python tools/validate_against_openapi.py
- [x] Create Ollama generate request/response models (AC: 2, 3)
  - [x] Define OllamaGenerateRequest in src/models/ollama.py
  - [x] Define OllamaGenerateResponse in src/models/ollama.py
  - [x] Add validation for required fields (model, prompt)
  - [x] Add optional parameters (stream, options)
  - [x] Ensure models match OpenAPI specification exactly
- [x] Implement /api/generate router (AC: 1, 4)
  - [x] Create src/routers/generate.py
  - [x] Add POST /api/generate endpoint
  - [x] Add request validation using Pydantic models
  - [x] Handle both streaming and non-streaming modes
- [x] Integration with translation service (AC: 4, 5, 6)
  - [x] Call translation service for request/response conversion
  - [x] Handle non-streaming responses as complete JSON
  - [x] Handle streaming responses as Server-Sent Events
- [x] Unit tests for generate endpoint (AC: 1-6)
  - [x] Test request validation
  - [x] Test non-streaming response format
  - [x] Test streaming response format
  - [x] Test error handling for invalid requests
- [x] API compliance validation (AC: 1-6)
  - [x] Run contract tests to verify compliance
  - [x] Test with Ollama CLI: ollama generate
  - [x] Test with Ollama SDK
  - [x] Validate using python tools/validate_against_openapi.py

## Dev Notes

### Previous Story Insights
No previous stories in Epic 2. This is the foundational endpoint for text generation.

### Data Models
[Source: architecture/data-models.md#ollamageneraterequest]
- **OllamaGenerateRequest**: model (str), prompt (str), stream (bool), options (Dict[str, Any])
- **OllamaGenerateResponse**: model (str), created_at (str), response (str), done (bool)

[Source: architecture/ollama-api-implementation.md#post-apigenerate]
Required request format:
```json
{
  "model": "llama2",
  "prompt": "Why is the sky blue?",
  "stream": false,
  "options": {
    "temperature": 0.7
  }
}
```

Non-streaming response format:
```json
{
  "model": "llama2",
  "created_at": "2023-08-04T19:56:02.647Z",
  "response": "The sky is blue because...",
  "done": true,
  "total_duration": 5589157167,
  "load_duration": 3013701500
}
```

Streaming response format (newline-delimited JSON):
```
{"model":"llama2","created_at":"2023-08-04T19:56:02.647Z","response":"The","done":false}
{"model":"llama2","created_at":"2023-08-04T19:56:02.647Z","response":" sky","done":false}
{"model":"llama2","created_at":"2023-08-04T19:56:02.647Z","response":"","done":true}
```

### API Specifications
[Source: architecture/ollama-api-implementation.md#critical-api-compliance-guidelines]
- Must validate against official Ollama API specification
- Use RFC3339 timestamp format with timezone offset
- Streaming format must be newline-delimited JSON, not arrays
- Both streaming and non-streaming modes required

[Source: architecture/api-compliance-checklist.md]
⚠️ **CRITICAL**: Before implementing, review the API Compliance Checklist
- The #1 cause of SDK failures is missing duplicate fields
- Always implement contract tests FIRST (TDD approach)
- Use the Postman collection: architecture/Ollama REST API.postman_collection.json
- Validate with: python tools/validate_against_openapi.py

### Component Specifications
[Source: architecture/source-tree.md]
- Router location: `src/routers/generate.py`
- Model definitions: `src/models/ollama.py`
- Integration with: `src/services/translator.py` and `src/services/openai_client.py`

### File Locations
[Source: architecture/source-tree.md]
- Main router: `src/routers/generate.py`
- Models: `src/models/ollama.py` (add generate models)
- Unit tests: `tests/unit/test_routers.py` (add generate tests)
- Integration tests: `tests/integration/test_streaming.py`

### Testing Requirements
[Source: architecture/coding-standards.md#core-standards]
- Test organization: `tests/{unit,integration}/test_*.py`
- All route handlers must be async
- Type hints required for all functions
- Unit tests must cover request validation, response formats, error handling
- Integration tests for streaming functionality

### Technical Constraints
[Source: architecture/tech-stack.md]
- Python 3.12 with FastAPI 0.109.0
- Use Pydantic 2.5.3 for data validation
- All route handlers must be async
- Virtual environment required for local development
- Must use existing OpenAI SDK wrapper service

### Testing
#### Test Standards
[Source: architecture/coding-standards.md]
- Test files in `tests/unit/` and `tests/integration/`
- Use pytest framework with pytest-asyncio for async testing
- All endpoint tests must be async
- Test both success and error cases
- Mock external dependencies (OpenAI service)

#### Specific Testing Requirements
- **Contract tests FIRST**: Must pass before implementing endpoint
  - Create tests/contract/test_generate_contract.py
  - Validate request/response against OpenAPI spec
  - Use tools/validate_against_openapi.py
- Unit tests: Request validation, response formatting, error handling
- Integration tests: End-to-end streaming functionality
- Test both streaming and non-streaming modes
- Verify timestamp formats and response structure
- Test with real Ollama CLI and SDK to ensure compatibility

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-23 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-23 | 1.1 | Story completed and status updated | James (Developer) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
claude-3-5-sonnet-20241022

### Debug Log References
- Initial implementation of /api/generate endpoint
- Contract tests created and passed
- Models implemented in src/models/ollama.py
- Router implemented in src/ollama_openai_proxy/routes/generate.py
- Integration with translation service completed
- All unit and integration tests passing

### Completion Notes List
- Implemented complete /api/generate endpoint with both streaming and non-streaming support
- Created comprehensive contract tests to ensure Ollama API compliance
- Integrated with enhanced translation service for request/response conversion
- All acceptance criteria met and validated through testing

### File List
- Created: src/ollama_openai_proxy/routes/generate.py
- Modified: src/ollama_openai_proxy/models/ollama.py (added GenerateRequest/Response models)
- Created: tests/contract/test_generate_contract.py
- Modified: tests/unit/test_routers.py (added generate endpoint tests)
- Modified: tests/integration/test_streaming.py (added generate streaming tests)
- Modified: src/ollama_openai_proxy/services/enhanced_translation_service.py (added generate translation methods)

## QA Results
*Results from QA Agent review will be populated here*